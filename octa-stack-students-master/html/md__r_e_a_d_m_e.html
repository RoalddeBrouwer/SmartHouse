<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SmartHouse: octa-stack &lt;!-- omit in toc --&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SmartHouse
   &#160;<span id="projectnumber">alpha</span>
   </div>
   <div id="projectbrief">Project for efficient inhouse energy usage</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">octa-stack  </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This repo contains the octa-stack with some example applications.</p>
<ul>
<li><a href="#architecture">Architecture</a><ul>
<li><a href="#core">core</a><ul>
<li><a href="#drivers">drivers</a></li>
<li><a href="#platform">platform</a><ul>
<li><a href="#common">common</a></li>
<li><a href="#octa">octa</a></li>
</ul>
</li>
<li><a href="#st">ST</a></li>
</ul>
</li>
<li><a href="#shields">shields</a></li>
<li><a href="#applications">applications</a></li>
</ul>
</li>
<li><a href="#makefiles">Makefiles</a><ul>
<li><a href="#application-makefile">Application Makefile</a><ul>
<li><a href="#application-name">Application Name</a></li>
<li><a href="#platform">Platform</a></li>
<li><a href="#float-support">Float Support</a></li>
<li><a href="#shield-definitions">Shield Definitions</a></li>
<li><a href="#bootloader">Bootloader</a></li>
<li><a href="#step-up-pin">Step Up Pin</a></li>
<li><a href="#link-to-core-makefile">Link to core makefile</a></li>
</ul>
</li>
<li><a href="#makefilecore">Makefile.core</a></li>
<li><a href="#makefileplatform">Makefile.platform</a></li>
<li><a href="#makefiledrivers">Makefile.drivers</a></li>
<li><a href="#makefileshields">Makefile.shields</a></li>
</ul>
</li>
<li><a href="#getting-started">Getting Started</a><ul>
<li><a href="#compiling">Compiling</a><ul>
<li><a href="#arm-none-eabi-gcc">arm-none-eabi-gcc</a></li>
<li><a href="#gnu-make">GNU Make</a></li>
</ul>
</li>
<li><a href="#flashing">Flashing</a><ul>
<li><a href="#st-link">ST-Link</a></li>
<li><a href="#switching-between-st-link-and-j-link">Switching between ST-Link and J-Link</a></li>
<li><a href="#j-link">J-Link</a></li>
</ul>
</li>
<li><a href="#make-command-overview">Make Command Overview</a></li>
<li><a href="#vscode-support">vscode support</a><ul>
<li><a href="#tasksjson">tasks.json</a></li>
<li><a href="#cortex-debug-extension">cortex-debug extension</a></li>
<li><a href="#launchjson">launch.json</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md1"></a>
Architecture</h1>
<p>The architecture of the octa-stack consists of three main parts being the <a href="#core">core</a>, <a href="#shields">shields</a> and <a href="#applications">applications</a>.</p>
<p><img src="documentation/images/octa-stack.png" alt="octa-stack architecture" class="inline"/>\ <em>octa-stack architecture</em></p>
<h2><a class="anchor" id="autotoc_md2"></a>
core</h2>
<p>The core of the stack consists of some common <a href="#drivers">drivers</a>, support for different <a href="#platforms">platforms</a> and platform independent <a href="#st">ST</a> code.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
drivers</h3>
<p>The drivers in this folder are common, and for the current octa platform always onboard and available.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
platform</h3>
<p>The platform sections consists of a common part and a part for each supported platform.</p>
<h4><a class="anchor" id="autotoc_md5"></a>
common</h4>
<p>The common platform has some common functions such as <code>Initialize_Platform()</code>. This will in turn call the platform initialize function of the selected platform. For now, this common part is rather limited.</p>
<h4><a class="anchor" id="autotoc_md6"></a>
octa</h4>
<p>This is the original platform, consisting of a <code>NucleoL496ZG-P</code> board, and the <code>octa-connect</code> expansion shield.\ Platform specific code for GPIO, UART, SPI, I2C, Watchdog Timers, Interrupts, FreeRTOS schedulers, etc is found here. Furthermore, the platform specific startup files and linker scripts are here.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
ST</h3>
<p>This section is for platform independent ST code:</p>
<ul>
<li><b>STM32L4xx_HAL_Driver:</b> The low level code of STM32L4 boards</li>
<li><b>Middlewares:</b> The ST middlewares, mainly used for FreeRTOS low level code</li>
<li><b>CMSIS:</b> The CMSIS-FreeRTOS API</li>
<li><b>SBSFU, SECoreBin, STM32_Cryptographic, STM32_Secure_Engine:</b> Low level Secure Boot and Secure Firmware Update code of ST, used for the FOTA bootloader</li>
<li><b>STM32CubeProgrammer:</b> Binaries to flash an ST-Link device from the commandline, used for the <code>make flash-st</code> command</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
shields</h2>
<p>The shields folder contains drivers for all kinds of pluggable shields such as sensor shields, communication shields etc.\ Every shield requires a header to be defined for it in the application makefile, as described in the <a href="#shield-definitions">shield definitions</a> section.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
applications</h2>
<p>Some example applications are provided in this repo:</p>
<ul>
<li><b>hello-world</b>: basic application, mainly to test the development environment setup.</li>
<li><b>acc-mag-sensor</b>: application using the accelerometer and magnetometer sensor on the octa.</li>
<li><b>lightsensor</b>: application using the lightsensor on the octa.</li>
<li><b>temperature-humidity</b>: application using the temperature &amp; humidity sensor on the octa.</li>
<li><b>bootloader-minimal-example</b>: application showing the minimal requirements for an application to be compatible with the SBSFU bootloader.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md10"></a>
Makefiles</h1>
<p>The stack uses Makefiles, with each application having a <code>Makefile</code> for the application settings.\ This Makefile links to the <code>Makefile.core</code>, which will link to all the required makefiles of the drivers, shields and platforms.</p>
<p>The end user should only come into contact with the <a href="#application-makefile">Application Makefile</a>. If this file is set up correctly, the rest should be automated.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Application Makefile</h2>
<p>This file contains the high level settings of the application, such as the name, platform and the required shields.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Application Name</h3>
<p>The application name is defined as follows, and will end up being the name of the target binary.</p>
<div class="fragment"><div class="line"># name of your application</div>
<div class="line">APPLICATION = hello-world</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md13"></a>
Platform</h3>
<p>The platform is defined as follows, with currently only the main octa platform being supported.</p>
<div class="fragment"><div class="line"># platform for which the application will be built</div>
<div class="line">PLATFORM ?= octa</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md14"></a>
Float Support</h3>
<p>If floats have to be printed of sprinted, some extra libraries have to be included. To do this, <code>PRINT_FLOATS</code> has to be set to 1.</p>
<div class="fragment"><div class="line"># Set PRINT_FLOATS to 1 to enable linker flags enabling float printf &amp; sprintf</div>
<div class="line">PRINT_FLOATS = 1</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md15"></a>
Shield Definitions</h3>
<p>To use a shield in the application, the user has to define the name of the shield and a header connector in the application makefile. This connector number is passed to the code as a define using a -D parameter when compiling.</p>
<div class="fragment"><div class="line"># SigFox</div>
<div class="line">SHIELDS += SigFox</div>
<div class="line">SIGFOX_CONNECTOR = 1</div>
</div><!-- fragment --><p>An <em>OCTA_header</em> struct will to be passed to the driver. This struct contains UART, I2C, SPI and GPIO Handles.\ These structs are defined during the platform initalization e.g. P1_header, P2_header, ...\ It is up to the shield driver to initialize the required handle with the driver's specific settings.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>OCTA_header{</div>
<div class="line">    uint8_t                     number;</div>
<div class="line">    UART_HandleTypeDef          *uartHandle;</div>
<div class="line">    I2C_HandleTypeDef           *i2cHandle;</div>
<div class="line">    SPI_HandleTypeDef           *spiHandle;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO1;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO2;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO3;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO4;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO5;</div>
<div class="line">    <span class="keyword">struct </span>OCTA_GPIO            *DIO6;</div>
<div class="line">    uint8_t                     active;</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md16"></a>
Bootloader</h3>
<p>To use the FOTA SBSFU bootloader in the application, this has to be set in the <code>Makefile</code> as follows.\ Some bootloader specific code also has to be implemented in the application, shown in the <em>bootloader-minimal-example</em> application.</p>
<div class="fragment"><div class="line"># use the SBSFU bootloader</div>
<div class="line">BOOTLOADER ?= 1</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md17"></a>
Step Up Pin</h3>
<p>To enable or disable the step up pin, the <code>ENABLE_STEPUP</code> variable has to be set to 1 or zero respectively. This will step up the battery voltage to 5V to the octa headers.</p>
<div class="fragment"><div class="line"># enable the stepup pin</div>
<div class="line">ENABLE_STEPUP ?= 1</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md18"></a>
Link to core makefile</h3>
<p>Finally, the link to the <code>Makefile.core</code> has to be made.</p>
<div class="fragment"><div class="line"># Path to the octa-stack base directory:</div>
<div class="line">STACKBASE ?= ../..</div>
<div class="line"> </div>
<div class="line">include $(STACKBASE)/core/Makefile.core</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md19"></a>
Makefile.core</h2>
<p>The <code>Makefile.core</code> file is, as the name suggests, the core of every application.\ First of all, the link to the selected platform, drivers and shields makefiles made.\ After the source files, header files, startup files and linker script are defined, the code is compiled to <code>application-name.hex,bin,elf</code>.</p>
<p>Furthermore, <code>make flash</code> support is provided.\ Both <code>J-Link</code> and <code>ST-Link</code> are <a href="#make-command-overview">supported</a> by using <em>make flash-jlink</em> and <em>make flash-st</em> respectively.</p>
<h2><a class="anchor" id="autotoc_md20"></a>
Makefile.platform</h2>
<p>In the <code>Makefile.platform</code> file, a check is done on the platform name of the application Makefile. If not valid, the make command will throw an error. If valid, the <code>Makefile.include</code> file of the common platform folder is included as well as the <code>Makefile.include</code> of said platform.\ This file sets some platform specific setting such as the <em>CPU</em> type, platform specific source and header files, startup file and linker scripts.</p>
<p>A <em>PLATFORM_DEFINE</em> define is also created, which is passed to the code in the <code>Makefile.core</code> file.</p>
<div class="fragment"><div class="line"># platform define var, passed to code when compiling in Makefile.core</div>
<div class="line">PLATFORM_DEFINE += -D$(addprefix platform_,$(PLATFORM))</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md21"></a>
Makefile.drivers</h2>
<p>The purpose of this file is to include every source and header file in the <code>core/drivers/*</code> folder.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Makefile.shields</h2>
<p>This file will make sure that for every shield defined in the application <code>Makefile</code>, its <code>Makefile.include</code> file is included.\ These files contain the source and header files of each shield respectively. It also serves as a way to not having to include every shield driver in every application.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md23"></a>
Getting Started</h1>
<p>This section will help you get started with compiling and flashing the code to the octa boards.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Compiling</h2>
<h3><a class="anchor" id="autotoc_md25"></a>
arm-none-eabi-gcc</h3>
<p>The <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads">arm-none-eabi-compiler</a> has to be installed. For it to work in every folder, it has to be added to the PATH variable.\ On linux, an <em>arm-none-eabi-gcc</em> package is also available. Once installed, the code can be compiled using the <a href="##Make-Command-Overview">make commands</a>.</p>
<h3><a class="anchor" id="autotoc_md26"></a>
GNU Make</h3>
<p>To support the <a href="#make-command-overview">make commands</a> on Windows, the <a href="http://gnuwin32.sourceforge.net/packages/make.htm">gnuwin32</a> package has to be installed.\ This binary folder also has to be added to the PATH variable.\ On Linux, Make should work as is.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Flashing</h2>
<p>With the on board debugger of the <code>Nucleo</code> board supporting both <code>ST-Link</code> and <code>J-Link</code> firmware, both are supported in the octa-stack.</p>
<h3><a class="anchor" id="autotoc_md28"></a>
ST-Link</h3>
<p>Out of the box, the on board debugger of the <code>Nucleo</code> board comes with <code>ST-Link</code> installed on it.\ To flash with the <code>ST-Link</code> debugger, the <code>STM32CubeProgrammerCLI</code> binaries are provided with the octa-stack.\ Make sure the <a href="https://www.st.com/en/development-tools/stsw-link009.html">ST-Link usb drivers</a> are installed.</p>
<h3><a class="anchor" id="autotoc_md29"></a>
Switching between ST-Link and J-Link</h3>
<p>To switch between <code>ST-Link</code> and <code>J-Link</code> and vice versa, a <a href="https://www.segger.com/products/debug-probes/j-link/models/other-j-links/st-link-on-board/">ST-Link Reflash Utility</a> is provided by Segger.\ This tool does only work on Windows, but can be used in a Windows Virtual Machine on linux as well.</p>
<h3><a class="anchor" id="autotoc_md30"></a>
J-Link</h3>
<p>Once switched to <code>J-Link</code> tools from the <a href="https://www.segger.com/downloads/jlink#J-LinkSoftwareAndDocumentationPack">J-Link Software and Documentation Pack</a> can be used with the onboard debugger.\ This is particularly useful for debugging in <a href="#cortex-debug-extension">vscode</a>.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Make Command Overview</h2>
<p>Every make command has to be run from the folder of the target application.\ <code>make flash</code> support is provided for both <code>ST-Link</code> and <code>J-Link</code>, allowing for independency of editor/IDE and the option to work entirely in the CLI.</p>
<ul>
<li><b>make</b>: this command will compile the code to a binary</li>
<li><b>make clean</b>: this command cleans up the build folder</li>
<li><b>make clean all</b>: this command cleans up the build folder, as well as recompile everything</li>
<li><b>make flash-st</b>: this command compiles the code and flashes the binary using <a href="#ST-Link">ST-Link</a></li>
<li><b>make flash-jlink</b>: this command compiles the code and flashes the binary using <a href="#J-Link">J-Link</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md32"></a>
vscode support</h2>
<p>Due to its flexibility, <a href="https://code.visualstudio.com/">vscode</a> is suggested as IDE.\ A <code>.vscode</code> folder is provided for building and flashing/debugging support.</p>
<h3><a class="anchor" id="autotoc_md33"></a>
tasks.json</h3>
<p>This file contains make and make clean all tasks for every application in the stack. These tasks can be ran by using the <code>ctrl+Shift+B</code> keyboard shortcut.</p>
<h3><a class="anchor" id="autotoc_md34"></a>
cortex-debug extension</h3>
<p>The <a href="https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug">cortex-debug</a> extension is particularly useful for debugging applications. It allows the user to set breakpoints, watch variables, registers, memory etc. This extension only works with <a href="#J-Link">J-Link</a> installed on the onboard debugger.</p>
<h3><a class="anchor" id="autotoc_md35"></a>
launch.json</h3>
<p>This file contains a launch tasks for every application in the octa-stack. After compiling the binary, it can be flashed and debugged by pressing the <code>F5</code> button and selecting the correct binary. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
